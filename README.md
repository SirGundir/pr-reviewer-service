# PR Reviewer Assignment Service

Сервис автоматического назначения ревьюеров на Pull Request’ы внутри команды.

## Описание

Сервис позволяет:

- Управлять командами и участниками
- Создавать Pull Request’ы и автоматически назначать до 2 ревьюверов из команды автора
- Переназначать ревьюверов на других участников команды
- Получать список PR’ов, назначенных конкретному пользователю
- Помечать PR как MERGED (идемпотентно)

Сервис полностью реализован через HTTP API (OpenAPI спецификация).

---

## Стек

- Язык: Go 1.23
- База данных: PostgreSQL (через Docker)
- Миграции: встроенные (при `docker-compose up`)
- Нагрузочное тестирование: k6
- Docker / Docker Compose

---

## Запуск сервиса

1. Клонируем репозиторий:

```bash
git clone <repo_url>
cd pr-reviewer-service
```

Поднимаем сервис через Docker Compose:
```bash
docker-compose up
```


Сервис доступен на порту 8080:
```bash
curl http://localhost:8080/health
```

## API
OpenAPI спецификация находится в openapi.yaml.

## Эндпоинты:
### Teams (Команды)

- `POST /team/add` — создать команду с участниками
- `GET /team/get?team_name=xxx` — получить команду
- `POST /team/deactivate` — деактивировать команду

### Users (Пользователи)

- `POST /users/setIsActive` — изменить активность пользователя
- `GET /users/getReview?user_id=xxx` — получить PR'ы пользователя

### Pull Requests

- `POST /pullRequest/create` — создать PR (автоназначение ревьюверов)
- `POST /pullRequest/merge` — пометить PR как MERGED (идемпотентно)
- `POST /pullRequest/reassign` — переназначить ревьювера

### Statistics

- `GET /stats/prs` — статистика по pull requests
- `GET /stats/users` — статистика по назначениям пользователей

### Интеграционные тесты
```bash
# 1. Убедитесь что сервис запущен
make docker-up

# 2. Запустить интеграционные тесты
make test-integration

# Или напрямую
go test -v -count=1 ./integration-test/...
```

## PR Reviewer Service — Результаты нагрузочного тестирования

Нагрузочное тестирование проводилось с использованием утилиты [`hey`](https://github.com/rakyll/hey) для проверки производительности основных эндпоинтов сервиса.

### 1. Health Check

**Эндпоинт:** `/health`  

| Метрика       | Значение      |
|---------------|---------------|
| Запросов      | 1000          |
| Параллельных  | 50            |
| Fastest       | 0.0009 сек    |
| Slowest       | 0.6963 сек    |
| Average       | 0.0318 сек    |
| Requests/sec  | 49.95         |

**Вывод:**  
Эндпоинт `/health` отвечает быстро даже при высокой параллельной нагрузке.  

---

### 2. Создание команды

**Эндпоинт:** `/team/add`  

- Тестовая команда создана успешно (`load-test-team`), ответ сервиса: `200 OK`.
- Статус код подтверждает успешное создание команды.

**Вывод:**  
Создание команды работает корректно и стабильно при единичном запросе.

---

### 3. Создание Pull Request

**Эндпоинт:** `/pullRequest/create`  

| Метрика       | Значение      |
|---------------|---------------|
| Запросов      | 100           |
| Параллельных  | 10            |
| Fastest       | 0.0056 сек    |
| Slowest       | 0.0956 сек    |
| Average       | 0.0553 сек    |
| Requests/sec  | 172.43        |

**Вывод:**  
Эндпоинт создания Pull Request быстро обрабатывает до 10 параллельных запросов и способен обрабатывать большое количество запросов без ошибок.

---

### 4. Статистика пользователей

**Эндпоинт:** `/stats/users`  

| Метрика       | Значение      |
|---------------|---------------|
| Запросов      | 500           |
| Параллельных  | 25            |
| Fastest       | 0.0023 сек    |
| Slowest       | 0.1000 сек    |
| Average       | 0.0149 сек    |
| Requests/sec  | 24.98         |

**Вывод:**  
Получение статистики по пользователям работает стабильно, даже при высокой нагрузке, с минимальными задержками.

---

### 5. Получение информации о команде

**Эндпоинт:** `/team/get?team_name=load-test-team`  

| Метрика       | Значение      |
|---------------|---------------|
| Запросов      | 200           |
| Параллельных  | 20            |
| Fastest       | 0.0037 сек    |
| Slowest       | 0.2626 сек    |
| Average       | 0.0460 сек    |
| Requests/sec  | 314.05        |

**Вывод:**  
- Сервис стабильно выдерживает высокую нагрузку на ключевые эндпоинты.
- Среднее время отклика для всех эндпоинтов находится в пределах 50 мс.
- Параллельная обработка запросов работает корректно.
- Ошибок 500 при нагрузочном тестировании обнаружено не было.